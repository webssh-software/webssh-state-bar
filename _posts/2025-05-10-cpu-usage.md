---
# -- Main Metadata --
layout: script
title: "CPU Usage"
description: |
  Retrieves the current CPU usage (percent) of the system.
date: 2025-05-10
author: 
  - "isontheline"
categories:
  - State Bar Item
  - Performance
  - CPU
tags:
  - CPU
  - Monitoring
  - Performance
# -- Script Metadata --
icon: "tachometer"
targets:
  - "Linux"
compatibility:
  WebSSH: ">=29.3"
  iOS: ">=17.2"
  iPadOS: ">=17.2"
  macOS: ">=14.0"
script: |
  (function() {
    function extractCpuTimes(statOutput) {
      const line = statOutput.split('\n').find(l => l.startsWith('cpu '));
      const parts = line.trim().split(/\s+/).slice(1, 8).map(Number); // user to softirq
      const total = parts.reduce((sum, val) => sum + val, 0);
      const idle = parts[3] + parts[4]; // idle + iowait
      return { total, idle };
    }

    const procStatContent = $ssh.exec('cat /proc/stat');
    const newStat = extractCpuTimes(procStatContent);
    const oldStat = $vars.get('CPU_STAT', newStat);
    $vars.set('CPU_STAT', newStat);

    const totalDiff = newStat.total - oldStat.total;
    const idleDiff = newStat.idle - oldStat.idle;
    let usagePercent;

    if (totalDiff > 0) {
      usagePercent = Math.round(100 * (totalDiff - idleDiff) / totalDiff);
    } else {
      usagePercent = 0;
    }

    let icon;
    if (usagePercent < 33) {
      icon = 'gauge.with.dots.needle.0percent';
    } else if (usagePercent < 50) {
      icon = 'gauge.with.dots.needle.33percent';
    } else if (usagePercent < 67) {
      icon = 'gauge.with.dots.needle.50percent';
    } else if (usagePercent < 80) {
      icon = 'gauge.with.dots.needle.67percent';
    } else {
      icon = 'gauge.with.dots.needle.100percent';
    }

    return { label: usagePercent + '%', icon };
  })();
---

This script retrieves the current CPU usage (percent) of the system by reading the `/proc/stat` file. It calculates the CPU usage based on the difference between the current and previous CPU times. The script uses a simple algorithm to determine the CPU usage percentage and returns it as a label with an appropriate icon.

Hope to be a cross-platform script in the future. Currently only Linux is supported.
